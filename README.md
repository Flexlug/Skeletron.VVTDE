# Skeletron.VVTDE
*Работа над проектом так и не завершена по причине различных откровенно козьих ошибок, с которыми автор устал бороться. Проект подает какие-то признаки жизни, но он скорее мёртв, чем жив.*

Дополнение к [Skeletron](https://github.com/Flexlug/Skeletron), позволяющий просматривать VK видео через Discord Embed.
Представляет собой Backend на базе ASP.NET, включающий в себя функции автоматической закачки видео из VK по запросу. В качестве инструмента для закачки видео используется [yt-dlp](https://github.com/yt-dlp).

## Принцип работы:
1. При парсинге поста из VK (или получении прямой ссылки на видео) бот проверяет длину видео. Если она больше заданной длины (1.5 минуты), то видео пропускается;
2. Бот отправляет запрос на backend. Идет проверка наличия информации о видео в БД. Если видео уже есть - возвращается его GUID. Если видео нет - генерируется новый GUID и начинается закачка.
3. Бот время от времени проверяет, закончилась ли закачка.
4. По завершению закачки бот отправляет ссылку в Discord канал. Ссылка ведет на backend, который по запросу Discord-а вернет web-страницу с нужными OpenGraph тегами. Это позволит сгенерировать Embed с видео.

## Endpoints
- `Video/Video?guid={Guid}` - возвращает веб-страницу с OpenGraph тегами;
- `Video/Watch?guid={Guid}` - возвращает видеофайл;
- `Video/RequestDownload` - запрос на закачку видео. Требует токен. Требует JSON:
```json
{
    "Url": "Ссылка на VK видео",
    "Title": "Заголовок видео, для OpenGraph",
    "Description": "Описание видео, для OpenGraph",
    "ImageUrl": "Thumbnail для видео"
}
```
Ответ: 
```json
{
    "Guid": "Сгенерированный GUID для видео",
    "AlreadyDownloaded": false // Имеется ли уже видео в наличии
}
```
- `Video/FetchVideo` - проверить, завершилась ли закачка видео. Требует токен. Требует JSON:
```json
{
    "Guid": "GUID видео"
}
```
Ответ:
```json
{
    "DownloadComplete": false // Завершена ли закачка видео 
}
```

## docker-compose
```yml
version: '3.8'

services:
  vvtde:
    build:
      context: .
    image: flexlug/vvtde:latest
    restart: always
    environment:
       # URI для подключения к БД
       "DbConnection": "Data Source=videos.db"
       # Директория, где хранится БД
       "DbFoler": "db"
       # Название исполняемого файла yt-dlp
       "YtDlpPath": "yt-dlp_linux"
       # Директория, в которой будут сохранаться видео
       "VideoDownloadPath": "static"
       # Токен, необходимый для доступа к Endpoint-ам FetchVideo и RequestDownload
       "Token": "SecretToken"
    volumes:
       # Директория для загруженных видео
       - /your/path/to/static:/app/static/
       # Директория, где хранится БД
       - ./db:/app/db
```

## Готовность:
- [x] Автоматическая закачка видео;
- [x] Web-страница с OpenGraph тегами;
- [x] Поддержка Docker;
- [ ] Проверка наличия видео в БД (работает неправильно);
- [ ] Отправка видеофайла (так-то работает, но возвращает ошибку Unsupported MIME type).
